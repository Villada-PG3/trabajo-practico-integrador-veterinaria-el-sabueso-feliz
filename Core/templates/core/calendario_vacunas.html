{% extends "core/header.html" %}

{% block title %}Calendario de Vacunas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 xl:px-0 mt-0 pt-0">
<div class="d-flex flex-column gap-4">
    <section class="card border-0 shadow-lg overflow-hidden">
        <div class="row g-0">
            <div class="col-lg-7 p-5 text-white" style="background: linear-gradient(135deg, #7a3aff 0%, #c084fc 50%, #7a3aff 120%);">
                <p class="text-uppercase small fw-semibold text-white-50 mb-2">Salud preventiva</p>
                <h1 class="display-6 fw-bold">Calendario inteligente de vacunas</h1>
                <p class="lead text-white-75 mb-4">Organiza el esquema segun la especie, registrando cada dosis y agregando observaciones clinicas. Todo queda sincronizado con el historial de tu mascota.</p>
                <div class="d-flex flex-wrap gap-2">
                    <a href="{% url 'registrar_mascota' %}" class="btn btn-light text-dark px-4">
                        <i class="bi bi-plus-circle me-2"></i>Registrar mascota
                    </a>
                    <a href="{% url 'mis_mascotas' %}" class="btn btn-outline-light px-4">
                        <i class="bi bi-journal-medical me-2"></i>Mis fichas clinicas
                    </a>
                </div>
                <div class="row row-cols-3 text-center mt-4 g-2 text-white-75">
                    <div class="col">
                        <p class="text-uppercase small mb-1">Mascotas</p>
                        <p class="fs-4 fw-bold">{{ mascotas|length }}</p>
                    </div>
                    <div class="col">
                        <p class="text-uppercase small mb-1">Vacunas previstas</p>
                        <p class="fs-4 fw-bold">{{ total_vacunas|default:"0" }}</p>
                    </div>
                    <div class="col">
                        <p class="text-uppercase small mb-1">Registros creados</p>
                        <p class="fs-4 fw-bold">{{ vacunas_completadas|default:"0" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 bg-light p-5">
                <div class="d-flex flex-column gap-3 h-100">
                    <h2 class="h5 fw-semibold text-uppercase text-muted">Como funciona</h2>
                    <ul class="list-unstyled mb-0 text-secondary small">
                        <li class="d-flex gap-3 mb-3">
                            <div class="badge rounded-pill text-bg-primary align-items-center">1</div>
                            Selecciona una mascota y detectamos automaticamente el calendario segun la especie.
                        </li>
                        <li class="d-flex gap-3 mb-3">
                            <div class="badge rounded-pill text-bg-primary align-items-center">2</div>
                            Al completar la aplicacion registra fecha y notas para mantener evidencia clinica.
                        </li>
                        <li class="d-flex gap-3">
                            <div class="badge rounded-pill text-bg-primary align-items-center">3</div>
                            Consulta los proximos refuerzos y estabiliza recordatorios para los tutores.
                        </li>
                    </ul>
                    <div class="mt-auto">
                        <div class="alert alert-info border-0 mb-0 small">
                            <i class="bi bi-lightning-charge-fill me-2"></i>
                            Mantene actualizada la especie y edad en el perfil de la mascota para obtener recomendaciones precisas.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% if mascota_seleccionada %}
        <section class="card border-0 shadow-sm">
            <div class="card-body p-4 d-flex flex-column flex-lg-row align-items-center justify-content-between gap-4">
                <div class="d-flex align-items-center gap-3">
                    {% with foto=mascota_seleccionada.foto %}
                        {% if foto %}
                            <img src="{{ foto.url }}" alt="Foto de {{ mascota_seleccionada.nombre }}" class="rounded-circle object-fit-cover" style="width:72px;height:72px;">
                        {% else %}
                            <div class="rounded-circle bg-primary-subtle text-primary d-flex align-items-center justify-content-center" style="width:72px;height:72px;">
                                <i class="bi bi-patch-plus fs-3"></i>
                            </div>
                        {% endif %}
                    {% endwith %}
                    <div>
                        <p class="text-uppercase small fw-semibold text-muted mb-1">Mascota activa</p>
                        <h2 class="h4 fw-bold mb-1">{{ mascota_seleccionada.nombre }}</h2>
                        <div class="text-muted small d-flex flex-wrap gap-3">
                            <span><i class="bi bi-shield-check me-1 text-primary"></i>{{ mascota_seleccionada.especie|default:"Sin especie" }}</span>
                            {% if mascota_seleccionada.raza %}<span><i class="bi bi-paw me-1 text-primary"></i>{{ mascota_seleccionada.raza }}</span>{% endif %}
                            {% if mascota_seleccionada.fecha_nacimiento %}<span><i class="bi bi-cake me-1 text-primary"></i>{{ mascota_seleccionada.fecha_nacimiento|date:"d/m/Y" }}</span>{% endif %}
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <a href="{% url 'detalle_mascota' mascota_seleccionada.id %}" class="btn btn-outline-primary px-4">
                        <i class="bi bi-card-list me-2"></i>Ver ficha completa
                    </a>
                    <a href="{% url 'agendar_cita' %}" class="btn btn-primary px-4">
                        <i class="bi bi-calendar2-plus me-2"></i>Agendar control
                    </a>
                </div>
            </div>
        </section>
    {% endif %}

    {% if not mascotas %}
        <section class="card border-0 shadow-sm text-center p-5 px-15 align-items-center">
            <i class="bi bi-paw display-5 text-primary mb-3"></i>
            <h2 class="h4 fw-bold mb-2">Todavia no registraste mascotas</h2>
            <p class="text-muted mb-4">Crea una ficha para habilitar recordatorios, calendarios personalizados y seguimiento preventivo.</p>
            <a href="{% url 'registrar_mascota' %}" class="btn btn-primary btn-lg" style="width: fit-content; padding: 0.5rem 3rem;">
                <i class="bi bi-plus-circle me-2"></i>Agregar mascota
            </a>
            
            
            
        </section>
    {% else %}
        <section class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 mb-4">
                    <div>
                        <p class="text-uppercase small fw-semibold text-muted mb-1">Paso 1</p>
                        <h2 class="h4 fw-bold mb-2">Elegir mascota</h2>
                        <p class="text-muted mb-0">Usa las tarjetas para alternar entre pacientes. Mostramos el calendario oficial para caninos y felinos.</p>
                    </div>
                    <div class="text-muted small">
                        Si la especie no es correcta podras cambiarla desde <a href="{% url 'mis_mascotas' %}" class="text-decoration-none fw-semibold">Mis mascotas</a>.
                    </div>
                </div>
                <div class="row g-3">
                    {% for mascota in mascotas %}
                        {% with especie_lower=mascota.especie|default:""|lower %}
                        <div class="col-md-4 col-lg-3">
                            <a href="{% url 'calendario_vacunas' %}?paciente={{ mascota.id }}" class="text-decoration-none">
                                <div class="border rounded-4 p-3 h-100 position-relative {% if mascota_seleccionada and mascota.id == mascota_seleccionada.id %}bg-primary text-white shadow{% else %}bg-white text-dark{% endif %}">
                                    {% if mascota_seleccionada and mascota.id == mascota_seleccionada.id %}
                                        <span class="badge bg-white text-primary position-absolute top-0 end-0 m-3">Activa</span>
                                    {% endif %}
                                    <div class="d-flex align-items-center gap-3">
                                        {% if mascota.foto %}
                                            <img src="{{ mascota.foto.url }}" alt="Foto de {{ mascota.nombre }}" class="avatar rounded-circle object-fit-cover" style="width:52px;height:52px;">
                                        {% else %}
                                            <div class="avatar rounded-circle d-flex align-items-center justify-content-center bg-light text-primary" style="width:52px;height:52px;">
                                                <i class="bi {% if 'gat' in especie_lower or 'fel' in especie_lower %}bi-emoji-smile{% else %}bi-paw{% endif %} fs-4"></i>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <p class="fw-bold mb-0">{{ mascota.nombre }}</p>
                                            <small class="{% if mascota_seleccionada and mascota.id == mascota_seleccionada.id %}text-white-75{% else %}text-muted{% endif %}">{{ mascota.especie|default:"Sin especie" }}</small>
                                        </div>
                                    </div>
                                    {% if mascota.raza %}
                                        <p class="mt-3 mb-0 small {% if mascota_seleccionada and mascota.id == mascota_seleccionada.id %}text-white-75{% else %}text-muted{% endif %}"><i class="bi bi-patch-check-fill me-1"></i>{{ mascota.raza }}</p>
                                    {% endif %}
                                </div>
                            </a>
                        </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </section>

        {% if not vacunas_disponibles %}
            <div class="alert alert-warning shadow-sm d-flex gap-3 align-items-start">
                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                <div>
                    <h3 class="h6 fw-semibold mb-1">Configuracion pendiente</h3>
                    <p class="mb-0">Ejecuta las migraciones mas recientes (<code>python manage.py migrate</code>) para cargar los esquemas y recarga la pagina.</p>
                </div>
            </div>
        {% elif not especie_normalizada %}
            <div class="alert alert-info shadow-sm d-flex gap-3 align-items-start">
                <i class="bi bi-info-circle-fill fs-4"></i>
                <div>
                    <h3 class="h6 fw-semibold mb-1">Calendario no disponible</h3>
                    <p class="mb-0">La especie de {{ mascota_seleccionada.nombre }} no coincide con los esquemas precargados. Configurala como Canino o Felino para ver recomendaciones.</p>
                </div>
            </div>
        {% else %}
            <div class="row g-4 align-items-stretch">
                <div class="col-lg-5">
                    <section class="card border-0 shadow-sm h-100">
                        <div class="card-body p-4 d-flex flex-column gap-3">
                            <div class="d-flex justify-content-between">
                                <span class="badge text-bg-primary text-uppercase">Resumen</span>
                                <span class="text-muted text-uppercase small">{{ especie_normalizada|capfirst }}</span>
                            </div>
                            <h3 class="h4 fw-bold mb-1">Progreso general</h3>
                            <p class="text-muted mb-3">{{ vacunas_completadas }} de {{ total_vacunas }} vacunas registradas.</p>
                            <div class="progress rounded-pill" style="height: 14px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ porcentaje_avance }}%; background: linear-gradient(90deg, #22d3ee 0%, #6366f1 100%);"></div>
                            </div>
                            <div class="d-flex justify-content-between text-muted small">
                                <span><i class="bi bi-check-circle-fill text-success me-2"></i>Completadas</span>
                                <span><i class="bi bi-clock-history text-warning me-2"></i>Pendientes: {{ vacunas_pendientes }}</span>
                            </div>
                            <div class="border-top pt-3">
                                <p class="text-uppercase small fw-semibold text-muted mb-2">Sugerencias rapidas</p>
                                <ul class="list-unstyled text-muted small mb-0">
                                    <li class="mb-2"><i class="bi bi-shield-check text-success me-2"></i>Guarda comprobantes o fotos tras cada aplicacion.</li>
                                    <li class="mb-2"><i class="bi bi-bell text-primary me-2"></i>Activa recordatorios en tu calendario personal.</li>
                                    <li><i class="bi bi-heart-pulse text-danger me-2"></i>Ante reacciones consulta al veterinario y registralo.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </div>
                <div class="col-lg-7">
                    <section class="card border-0 shadow-sm h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <p class="text-uppercase small fw-semibold text-muted mb-1">Paso 2</p>
                                    <h3 class="h5 fw-bold mb-0">Registrar o actualizar dosis</h3>
                                </div>
                                <span class="badge text-bg-light text-muted">Ultima visita: {{ hoy|date:"d/m/Y" }}</span>
                            </div>
                            <p class="text-muted small mb-4">Controla el timeline para saber que corresponde aplicar segun la edad o semanas transcurridas. Cada tarjeta permite registrar la dosis en un click.</p>
                            <div class="position-relative ps-4">
                                <span class="position-absolute top-0 start-0 bottom-0 bg-primary-subtle" style="width: 3px;"></span>
                                {% for item in vacunas_info %}
                                    <article class="position-relative mb-4">
                                        <span class="position-absolute translate-middle rounded-circle {% if item.registro %}bg-success{% else %}bg-warning{% endif %}" style="left: -8px; width: 16px; height: 16px;"></span>
                                        <div class="card border-0 shadow-sm ms-2">
                                            <div class="card-body p-4">
                                                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                                    <div>
                                                        <h4 class="h5 fw-semibold mb-1">{{ item.vacuna.nombre }}</h4>
                                                        <p class="text-muted small mb-0">Edad sugerida: <strong>{{ item.vacuna.edad_legible }}</strong>{% if item.vacuna.refuerzo %} - {{ item.vacuna.refuerzo }}{% endif %}</p>
                                                    </div>
                                                    <span class="badge {% if item.registro %}text-bg-success{% else %}text-bg-warning text-dark{% endif %} rounded-pill px-3 py-2">
                                                        {% if item.registro %}<i class="bi bi-check-circle-fill me-1"></i>Aplicada{% else %}<i class="bi bi-clock me-1"></i>Pendiente{% endif %}
                                                    </span>
                                                </div>
                                                {% if item.vacuna.descripcion %}
                                                    <p class="text-muted small mb-4">{{ item.vacuna.descripcion }}</p>
                                                {% endif %}
                                                <form method="post" class="row g-3 align-items-end">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="accion" value="marcar">
                                                    <input type="hidden" name="paciente_id" value="{{ mascota_seleccionada.id }}">
                                                    <input type="hidden" name="vacuna_id" value="{{ item.vacuna.id }}">
                                                    <div class="col-md-4">
                                                        <label class="form-label small text-uppercase fw-semibold">Fecha de aplicacion</label>
                                                         <input type="date" name="fecha_aplicacion" class="form-control"
                                                           value="{% if item.registro %}{{ item.registro.fecha_aplicacion|date:'Y-m-d' }}{% else %}{{ hoy|date:'Y-m-d' }}{% endif %}"
                                                           max="{{ hoy|date:'Y-m-d' }}" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label small text-uppercase fw-semibold">Notas</label>
                                                        <textarea name="notas" class="form-control" rows="2" placeholder="Observaciones clinicas opcionales">{% if item.registro %}{{ item.registro.notas }}{% endif %}</textarea>
                                                    </div>
                                                    <div class="col-md-2 d-grid">
                                                        <button type="submit" class="btn {% if item.registro %}btn-success{% else %}btn-primary{% endif %}">
                                                            {% if item.registro %}<i class="bi bi-save me-1"></i>Actualizar{% else %}<i class="bi bi-check2-circle me-1"></i>Registrar{% endif %}
                                                        </button>
                                                    </div>
                                                </form>
                                                {% if item.registro %}
                                                    <div class="mt-3 d-flex flex-wrap align-items-center justify-content-between text-muted small">
                                                        <div>
                                                            <i class="bi bi-calendar-event me-2"></i>Registrada el {{ item.registro.fecha_aplicacion|date:"d/m/Y" }}
                                                            {% if item.registro.notas %}<span class="ms-2"><i class="bi bi-card-text me-1"></i>{{ item.registro.notas }}</span>{% endif %}
                                                        </div>
                                                        <form method="post" onsubmit="return confirm('Eliminar el registro de esta vacuna?');">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="accion" value="desmarcar">
                                                            <input type="hidden" name="paciente_id" value="{{ mascota_seleccionada.id }}">
                                                            <input type="hidden" name="vacuna_id" value="{{ item.vacuna.id }}">
                                                            <button type="submit" class="btn btn-link text-danger p-0"><i class="bi bi-trash me-1"></i>Eliminar registro</button>
                                                        </form>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </article>
                                {% empty %}
                                    <div class="alert alert-light border text-muted">No se encontraron vacunas configuradas para esta especie.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
</div>
{% endblock %}
