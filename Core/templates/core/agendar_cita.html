{% extends "core/header.html" %}
{% load static %}

{% block title %}Agendar cita - Veterinaria{% endblock %}

{% block main_class %}max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10{% endblock %}

{% block content %}
<div class="space-y-6">
    <section class="rounded-3xl bg-gradient-to-r from-purple-500 via-purple-400 to-purple-400 p-6 text-white shadow-xl">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="max-w-xl space-y-2">
                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-white/70">Agenda online</p>
                <h1 class="text-3xl font-bold">Solicita tu proxima cita</h1>
                <p class="text-sm text-white/80">
                    Elegi la mascota, sucursal y fecha preferida. Nuestro equipo coordinara el horario via WhatsApp para confirmarte el turno.
                </p>
            </div>
            <div class="rounded-2xl bg-white/10 px-4 py-3 text-xs">
                <p class="font-semibold">Soporte inmediato</p>
                <p class="text-white/80">WhatsApp central: 351 555-0000</p>
            </div>
        </div>
    </section>

    <section class="overflow-hidden rounded-3xl border border-gray-100 bg-white shadow-lg">
        <div class="grid grid-cols-1 gap-0 lg:grid-cols-3">
            <div class="space-y-4 border-b border-gray-100 bg-gray-50/60 p-6 lg:border-b-0 lg:border-r">
                <h2 class="text-sm font-semibold uppercase text-gray-500">Resumen</h2>
                <div class="rounded-2xl border border-white bg-white p-4 shadow-sm">
                    <p class="text-xs uppercase tracking-[0.35em] text-gray-400">Mascota seleccionada</p>
                    {% if paciente_seleccionado %}
                        <h3 class="mt-2 text-xl font-bold text-gray-900">{{ paciente_seleccionado.nombre }}</h3>
                        <p class="text-sm text-gray-500">{{ paciente_seleccionado.especie }}{% if paciente_seleccionado.raza %} - {{ paciente_seleccionado.raza }}{% endif %}</p>
                    {% else %}
                        <p class="mt-2 text-sm text-gray-500">Elegir en el formulario</p>
                    {% endif %}
                </div>
                <div class="rounded-2xl border border-white bg-white p-4 shadow-sm">
                    <p class="text-xs uppercase tracking-[0.35em] text-gray-400">Sucursal</p>
                    {% if sucursal_seleccionada %}
                        <h3 class="mt-2 text-lg font-semibold text-gray-900">{{ sucursal_seleccionada.nombre }}</h3>
                        <p class="text-sm text-gray-500">{{ sucursal_seleccionada.direccion }}</p>
                    {% else %}
                        <p class="mt-2 text-sm text-gray-500">Te asignaremos la mas cercana.</p>
                    {% endif %}
                </div>
                <div class="rounded-2xl border border-white bg-white p-4 shadow-sm">
                    <p class="text-xs uppercase tracking-[0.35em] text-gray-400">Que esperar</p>
                    <ul class="mt-2 space-y-2 text-sm text-gray-600">
                        <li class="flex items-start gap-2"><i class="fas fa-check text-emerald-500 mt-1"></i>Confirmacion por WhatsApp en menos de 24 hs.</li>
                        <li class="flex items-start gap-2"><i class="fas fa-check text-emerald-500 mt-1"></i>Recordatorios automaticos.</li>
                        <li class="flex items-start gap-2"><i class="fas fa-check text-emerald-500 mt-1"></i>Posibilidad de reagendar sin costo.</li>
                    </ul>
                </div>
            </div>
            <div class="lg:col-span-2 p-6">
                {% if messages %}
                    <div class="mb-4 space-y-2">
                        {% for message in messages %}
                            <div class="rounded-2xl border px-4 py-3 text-sm {% if message.tags == 'success' %}border-emerald-200 bg-emerald-50 text-emerald-700{% else %}border-rose-200 bg-rose-50 text-rose-700{% endif %}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                <form method="post" class="space-y-5">
                    {% csrf_token %}
                    <div>
                        <label for="paciente" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Mascota</label>
                        <select name="paciente" id="paciente" required class="mt-2 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm text-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                            {% for m in mascotas %}
                                <option value="{{ m.id }}" {% if paciente_seleccionado and paciente_seleccionado.id == m.id %}selected{% endif %}>
                                    {{ m.nombre }} ({{ m.especie }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="sucursal" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Sucursal</label>
                        <select name="sucursal" id="sucursal" required class="mt-2 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm text-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                            <option value="" disabled {% if not sucursal_seleccionada %}selected{% endif %}>Selecciona una sucursal</option>
                            {% for sucursal in sucursales %}
                                <option value="{{ sucursal.id }}" {% if sucursal_seleccionada and sucursal_seleccionada.id == sucursal.id %}selected{% endif %}>
                                    {{ sucursal.nombre }} - {{ sucursal.direccion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="rounded-2xl border border-indigo-100 bg-indigo-50 px-4 py-3 text-sm text-indigo-700">
                        Elegi el dia que prefieras y coordinaremos el horario contigo via WhatsApp. Recorda tener disponible tu contacto actualizado.
                    </div>
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
                        <div>
                            <label for="fecha_solicitada" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Dia preferido</label>
                            <input type="date" name="fecha_solicitada" id="fecha_solicitada" value="{{ request.POST.fecha_solicitada }}" required class="mt-2 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm text-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                        </div>
                        <div>
                            <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Preferencias</label>
                            <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-gray-600">
                                <label class="flex items-center gap-2 rounded-2xl border border-gray-200 px-3 py-2">
                                    <input type="radio" name="franja" value="manana" {% if request.POST.franja == 'manana' %}checked{% endif %}>
                                    Manana
                                </label>
                                <label class="flex items-center gap-2 rounded-2xl border border-gray-200 px-3 py-2">
                                    <input type="radio" name="franja" value="tarde" {% if request.POST.franja == 'tarde' %}checked{% endif %}>
                                    Tarde
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="notas" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Notas</label>
                        <textarea name="notas" id="notas" rows="4" placeholder="Motivo de la consulta, antecedentes o advertencias" class="mt-2 w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm text-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">{{ request.POST.notas }}</textarea>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <p class="text-xs text-gray-500">Al continuar aceptas nuestra politica de tratamiento de datos.</p>
                        <button type="submit" class="inline-flex items-center gap-2 rounded-2xl bg-indigo-600 px-6 py-3 text-sm font-semibold text-white shadow hover:bg-indigo-700">
                            <i class="fas fa-calendar-plus"></i>
                            Agendar cita
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const radios = document.querySelectorAll('input[name="franja"]');
    const notas = document.getElementById("notas");
    if (!radios.length || !notas) {
        return;
    }

    const preferenciaTexto = (valor) => {
        if (valor === "manana") {
            return "Horario preferido: manana.";
        }
        if (valor === "tarde") {
            return "Horario preferido: tarde.";
        }
        return "";
    };

    const registrarPreferencia = (valor) => {
        const actual = notas.value || "";
        const sinPref = actual.replace(/\s*Horario preferido: (manana|tarde)\./gi, "").trim();
        const texto = preferenciaTexto(valor);
        notas.value = texto ? (sinPref ? sinPref + "\n" + texto : texto) : sinPref;
    };

    radios.forEach((radio) => {
        radio.addEventListener("change", () => registrarPreferencia(radio.value));
        if (radio.checked) {
            registrarPreferencia(radio.value);
        }
    });
});
</script>
{% endblock %}
